<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="img/logo.png" type="image/png">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

  <link rel="stylesheet" href="css/applications.css" />
  <title>X-Project</title>
  <style>
    .container {
      padding: 20px;
      margin: auto;
      max-width: 1300px;
    }
    .search-bar {
      display: flex;
      justify-content: space-between;
      margin-top: 7px;
    }
    .search-bar input {
      padding: 8px;
      width: 200px;
    }
    .status-filter select {
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 2px;
      text-align: left;
      font-size: 9px;
    }
    table th {
      background-color: #f2f2f2;
    }
    .btn {
      padding: 8px 16px;
      color: white;
      border: none;
      cursor: pointer;
      margin: 0 5px;
    }
    .accept {
      background-color: green;
    }
    .waiting {
      background-color: #de7a23;
    }
    .reject {
      background-color: red;
    }

    
 
  </style>
</head>
<body>

  <!-- Nav -->
  <nav>
    <div class="logo">
      <img src="img/logo.png" alt="logo" />
      <a href="#">X-Project</a>
    </div>
  </nav>

  <!-- Table and Search -->
  <div class="container">
    <!-- Search bar -->
    <div style=" display: flex; justify-content: space-between; align-items: center;">
      <!-- Search bar -->
      <div class="search-bar">
        <input type="text" id="search" placeholder="Search by name or phone" style="padding: 8px; width: 200px;">
      </div>
    
      <!-- Filters and Counter -->
      <div style="display: flex; gap: 10px; align-items: center;">
        <label id="filterCount" style="font-weight: bold; font-size: 16px;">Total: 0</label>
    
        <button onclick="downloadExcel()" style="background-color: #f99325; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s;">
          Download Data
        </button>
    
        <div class="status-filter">
          <select id="statusFilter" style="padding: 8px;">
            <option value="">Filter by Status</option>
            <option value="0">Waiting</option>
            <option value="1">Accepted</option>
            <option value="2">Rejected</option>
          </select>
        </div>
    
        <div class="committee-filter">
          <select id="committeeFilter" style="padding: 8px;">
            <option value="">Filter by Committee</option>
            <option value="Marketing">Marketing</option>
            <option value="Graphic Designer">Graphic Design</option>
            <option value="Web Development">Web Development</option>
            <option value="Photography">Photography</option>
            <option value="Project Management">Project Management</option>
            <option value="⁠AC Coaching & Juniors">⁠AC Coaching & Juniors</option>
            <option value="⁠Social Responsibility">⁠Social Responsibility</option>
            <option value="Public Relations">Public Relations</option>
            <option value="Logistics & Events">Logistics & Events</option>
            <option value="Fundraising">Fundraising</option>
            <option value="HR & QM">Human Resources & Quality Management</option>
          </select>
        </div>
      </div>
    </div>
    
    

    <!-- Table -->
    <table id="applicationsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Faculty</th>
          <!-- <th>Collage</th> -->
          <th>Level</th>
          <th>Strengths</th>
          <th>Weaknesses</th>
          <th>Committee</th>
      
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be loaded here dynamically -->
      </tbody>
    </table>
  </div>

  <script>
    
    let applicationsData = [];

    async function fetchApplications() {
  try {
    const response = await fetch("https://x-project.co/public/api/applications/all");
    const data = await response.json();
    applicationsData = data.data; // Save the data for search/filter

    renderTable(applicationsData);

    // Update the counter with the total number of applications
    const filterCountLabel = document.querySelector("#filterCount");
    filterCountLabel.textContent = `Total: ${applicationsData.length}`;
  } catch (error) {
    console.error("Error fetching applications:", error);
  }
}

    function renderTable(applications) {
      const tableBody = document.querySelector("#applicationsTable tbody");
      tableBody.innerHTML = ""; // Clear previous data
      applications.forEach((app) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${app.name}</td>
          <td>${app.email}</td>
          <td>${app.phone}</td>
          <td>${app.faculty}</td>
          
          <td>${app.level}</td>
          <td>${app.strengths}</td>
          <td>${app.weaknesses}</td>
          <td>${app.committee}</td>
               <td>${getStatusLabel(app.status)}</td>
          <td>
            <button class="btn accept" onclick="changeStatus(${app.id}, 1)">Accept</button>
            <button class="btn waiting" onclick="changeStatus(${app.id}, 0)">Waiting</button>
            <button class="btn reject" onclick="changeStatus(${app.id}, 2)">Reject</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function filterData() {
  const selectedCommittee = document.querySelector("#committeeFilter").value.toLowerCase();
  const selectedStatus = document.querySelector("#statusFilter").value;
  const searchQuery = document.querySelector("#search").value.toLowerCase();
  const filterCountLabel = document.querySelector("#filterCount");

  const filteredData = applicationsData.filter((app) => {
    // تعديل الفلتر بحيث يشمل جميع اللجان في الـcommittee
    const matchesCommittee = selectedCommittee
      ? app.committee.toLowerCase().includes(selectedCommittee)
      : true;

    const matchesStatus = selectedStatus
      ? app.status == selectedStatus
      : true;

    const matchesSearch = searchQuery
      ? app.name.toLowerCase().includes(searchQuery) || app.phone.includes(searchQuery)
      : true;

    return matchesCommittee && matchesStatus && matchesSearch;
  });

  renderTable(filteredData);
  
  // تحديث العدد
  filterCountLabel.textContent = `Total: ${filteredData.length}`;
}


    function getStatusLabel(status) {
      if (status === 0) return "Waiting";
      if (status === 1) return "Accepted";
      return "Rejected";
    }

    async function changeStatus(id, status) {
  try {
    const response = await fetch(
      `https://x-project.co/public/api/applications/change-status/${id}`,
      {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ status }),
      }
    );

    if (response.ok) {
      // تحديث الحالة في البيانات الحالية بدون إعادة تحميل كامل
      const application = applicationsData.find(app => app.id === id);
      if (application) {
        application.status = status;
      }

      // تحديث الجدول مباشرة بعد تعديل الحالة
      filterData(); // الاحتفاظ بالفلاتر المطبقة
    } else {
      const data = await response.json();
      alert(data.message);
    }
  } catch (error) {
    console.error("Error changing status:", error);
  }
}

    // Attach event listeners
    document.querySelector("#search").addEventListener("input", filterData);
    document.querySelector("#statusFilter").addEventListener("change", filterData);
    document.querySelector("#committeeFilter").addEventListener("change", filterData);

    // Initialize data fetching
    fetchApplications();
  </script>

<script>
function extractTableData() {
  const table = document.getElementById('applicationsTable');
  const rows = table.querySelectorAll('tr');
  const data = [];

  rows.forEach(row => {
    const rowData = [];
    const cells = row.querySelectorAll('td');
    cells.forEach((cell, index) => {
      // نتجاهل العمود الأخير (الـ "Actions")
      if (index < cells.length - 1) {
        rowData.push(cell.textContent);
      }
    });
    if (rowData.length > 0) {
      data.push(rowData);
    }
  });

  return data;
}

function downloadExcel() {
  const tableData = extractTableData();
  const ws = XLSX.utils.aoa_to_sheet(tableData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Applications");
  XLSX.writeFile(wb, "applications.xlsx");
}
</script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="js/history.js"></script>
</body>

</html>
