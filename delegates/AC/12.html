<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="../../img/logo.png" type="image/png">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

  <link rel="stylesheet" href="css/applications.css" />
  <title>X-Project</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap");

    body {
      background-image: url('../../img/qr/BG.png');
      color: #ffffff;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      padding: 20px;
      margin: auto;
      max-width: 1300px;
    }
    .search-bar {
      display: flex;
      justify-content: space-between;
      margin-top: 7px;
    }
    .search-bar input {
      padding: 8px;
      width: 200px;
    }
    .status-filter select {
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      overflow-x: auto;
      display: block;
    }
    table th, table td {
      min-width: 100px;
      border: 1px solid #000;
      padding: 2px;
      text-align: center;
      font-size: 9px;
      color: #ffff;
    }
    
    table th {
      background-color: #000;
      color: #ffff;
    }
    .btn {
      padding: 8px 16px;
      color: white;
      border: none;
      cursor: pointer;
      margin: 0 5px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0px 0px 10px gray;
      width: 90%;
      max-width: 400px;
    }
    .modal.active {
      display: block;
    }
    @media screen and (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .search-bar {
        flex-direction: column;
        align-items: center;
      }
      .search-bar input {
        width: 100%;
        margin-bottom: 10px;
      }
      table {
        display: block;
        overflow-x: auto;
      }
      table th, table td {
        font-size: 8px;
        padding: 2px;
      }
      .btn {
        padding: 6px 10px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- Nav -->
  <!-- <nav>
    <div class="logo">
      <img src="../../img/logo.png" alt="logo" />
      <a href="#">X-Project</a>
    </div>
  </nav> -->

  <!-- Table and Search -->
  <div class="container">
    <!-- Search bar -->
    <div style=" display: flex; justify-content: space-between; align-items: center;">
      <!-- Search bar -->
      <div class="search-bar">
        <input type="text" id="search" placeholder="Search by name or phone" style="padding: 8px; width: 200px;" oninput="searchApplications()">
      </div>
    
      <!-- Filters and Counter -->
      <div style="display: flex; gap: 10px; align-items: center;">
        <label id="filterCount" style="font-weight: bold; font-size: 16px;">Total: 0</label>
    
        
    
        
    
        
      </div>
    </div>
    
    

    <!-- Table -->
    <table id="applicationsTable">
      <thead>
        <tr>
          <th>Called</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Faculty</th>
          <th>Level</th>
          <th>Strengths</th>
          <th>Weaknesses</th>
          <th>Interview Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be loaded dynamically -->
      </tbody>
    </table>
  </div>

  <script>
    async function fetchApplications() {
      try {
        const response = await fetch("https://x-project.co/public/api/delegate/all");
        const data = await response.json();
        applicationsData = data.data;
        document.getElementById("filterCount").textContent = `Total: ${applicationsData.length}`;

        renderTable(applicationsData);
      } catch (error) {
        console.error("Error fetching applications:", error);
      }
    }
    
    function renderTable(applications) {
  const tableBody = document.querySelector("#applicationsTable tbody");
  tableBody.innerHTML = "";

  applications.forEach((app) => {
    console.log(`ID: ${app.id}, Called: ${app.called}`); // ÿπŸÑÿ¥ÿßŸÜ ŸÜÿ¥ŸàŸÅ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ±ÿßÿ¨ÿπÿ©

    const isCalled = app.called === 1 || app.called === "1" ? "checked" : "";
    const isNotCalled = app.called === 0 || app.called === "0" ? "checked" : "";

    const row = document.createElement("tr");
    row.innerHTML = `
    <td>
        <label>
          <input type="radio" name="called_${app.id}" value="1" onclick="changeCalledStatus(${app.id}, 1)" ${isCalled}> Yes
        </label>
        <label>
          <input type="radio" name="called_${app.id}" value="0" onclick="changeCalledStatus(${app.id}, 0)" ${isNotCalled}> No
        </label>
      </td>
      <td>${app.name}</td>
      <td>${app.email}</td>
      <td>${app.phone}</td>
      <td>${app.faculty}</td>
      <td>${app.level}</td>
      <td>${app.strengths}</td>
      <td>${app.weaknesses}</td>
      
      <td><input class="btn" style="background-color: rgba(249, 147, 37, 0.9);" type="datetime-local" value="${app.interview_date || ''}" onchange="scheduleInterview(${app.id}, this.value)"></td>
      <td>
        <button class="btn" onclick="sendWhatsApp('${app.phone}', '${app.name}')" style="background-color: rgba(249, 147, 37, 0.9);">WhatsApp</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

    
    async function changeCalledStatus(id, called) {
      try {
        await fetch(`https://x-project.co/public/api/delegate/called/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ called })
        });
      } catch (error) {
        console.error("Error updating called status:", error);
      }
    }

    function formatDateTime(isoString) {
    const date = new Date(isoString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    const hours = String(date.getHours()).padStart(2, "0");
    const minutes = String(date.getMinutes()).padStart(2, "0");

    return `${year}-${month}-${day} ${hours}:${minutes}`;
}
    
    async function scheduleInterview(id, interviewDate) {
      try {
        const formattedDate = formatDateTime(interviewDate);
        console.log(formattedDate);
        await fetch(`https://x-project.co/public/api/delegate/schedule-interview/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ interview_date: formattedDate })
        });
      } catch (error) {
        console.error("Error scheduling interview:", error);
      }
    }

    function searchApplications() {
      const searchText = document.getElementById("search").value.toLowerCase();
      const filteredData = applicationsData.filter((app) =>
        app.name.toLowerCase().includes(searchText) || app.phone.includes(searchText)
      );
      renderTable(filteredData);
    }

    
    function sendWhatsApp(phone, name) {
      const message = `Hey ${name},\n\nOur best delegate ü´°\nWe're waiting for you to join us and take the lead! ü§©\n\nüìç Interview Details:\nüïê Time: Tomorrow at 1:00 PM\nüìç Location: Whale, Dokki\nüîó https://maps.app.goo.gl/Rg3YdwzAe4ZadxjLA?g_st=com.google.maps.preview.copy\n\nSee you there! üí™\n\nBest,\nAhmed Meslhe\nAC & JR Member | XProject`;
      window.open(`https://wa.me/+2${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }

    function filterByCalledStatus(status) {
      let filteredData;
      if (status === 'all') {
        filteredData = applicationsData;
      } else {
        const statusValue = status === 'yes' ? 1 : 0;
        filteredData = applicationsData.filter(app => app.called == statusValue);
      }
      renderTable(filteredData);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const searchBar = document.querySelector(".search-bar");
      
      const filterDropdown = document.createElement("select");
      filterDropdown.innerHTML = `
        <option value="all">All</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      `;
      filterDropdown.style.padding = "8px";
      filterDropdown.onchange = () => filterByCalledStatus(filterDropdown.value);
      
      searchBar.appendChild(filterDropdown);
    });
    
    document.addEventListener("DOMContentLoaded", fetchApplications);

  
    </script>
    

<script>
function extractTableData() {
  const table = document.getElementById('applicationsTable');
  const rows = table.querySelectorAll('tr');
  const data = [];

  rows.forEach(row => {
    const rowData = [];
    const cells = row.querySelectorAll('td');
    cells.forEach((cell, index) => {
      // ŸÜÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ£ÿÆŸäÿ± (ÿßŸÑŸÄ "Actions")
      if (index < cells.length - 1) {
        rowData.push(cell.textContent);
      }
    });
    if (rowData.length > 0) {
      data.push(rowData);
    }
  });

  return data;
}

</script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="js/history.js"></script>
</body>

</html>
